image: docker:stable

variables:
  DOCKER_HOST: tcp://docker:2375/
  DOCKER_DRIVER: overlay2

services:
- docker:dind

stages:
- build
#- push

build:
  stage: build
  artifacts:
    paths:
    - output.tgz
    expire_in: 1h
  script:
#  - mkdir -p ~/.docker
#  - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > ~/.docker/config.json
  - git submodule update --init
  - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME $CI_PROJECT_DIR
  - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME

#build-prod:
#  stage: build
#  image:
#    name: gcr.io/kaniko-project/executor:debug
#    entrypoint: ["/busybox/sh"]
#  script:
#    - mkdir -p /root/.docker
#    - echo "{\"auths\":{\"$REGISTRY\":{\"auth\":\"$REGISTRY_CREDENTIALS\"}}}" > /root/.docker/config.json
#    - /kaniko/executor --context $CI_PROJECT_DIR --destination $CI_PROJECT_NAME:$CI_COMMIT_REF_NAME
#  only:
#    - tags
